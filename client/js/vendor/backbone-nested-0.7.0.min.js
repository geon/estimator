/*! backbone-nested - 0.7.0 */
!function(a){"undefined"!=typeof Backbone||"undefined"!=typeof exports?a(Backbone):"function"==typeof define&&define.amd&&define(["backbone"],function(){a(Backbone)})}(function(a){var b=a.Model,c=a.Collection;a.Model.prototype.setRelation=function(a,d,e){var f=this.attributes[a],g=this.idAttribute||"id",h=[],i=[];if(e.unset&&f&&delete f.parent,this.relations&&_.has(this.relations,a)){if(f&&f instanceof c)return d instanceof c||d instanceof Array?(d=d.models||d,h=_.clone(d),f.each(function(a,b){if("undefined"!=typeof a[g]){var c=_.find(d,function(b){return b[g]===a[g]});c?(a.set(c.toJSON?c.toJSON():c),h.splice(b,1)):i.push(a)}}),_.each(i,function(a){f.remove(a)}),f.add(h)):f.each(function(a){d[g]===a[g]?a.set(d):f.remove(a)}),f;if(f&&f instanceof b)return f.set(d),f;e._parent=this,d=new this.relations[a](d,e),d.parent=this}return d},a.Model.prototype.set=function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a)return this;if("object"==typeof a?(e=a,c=b):(e={})[a]=b,c||(c={}),!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],i=this._changing,this._changing=!0,i||(this._previousAttributes=_.clone(this.attributes),this.changed={}),k=this.attributes,j=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]);for(d in e)b=e[d],b=this.setRelation(d,b,c),_.isEqual(k[d],b)||g.push(d),_.isEqual(j[d],b)?delete this.changed[d]:this.changed[d]=b,f?delete k[d]:k[d]=b;if(!h){g.length&&(this._pending=!0);for(var l=0,m=g.length;m>l;l++)this.trigger("change:"+g[l],this,k[g[l]],c)}if(i)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this},a.Model.prototype.toJSON=function(){var a=_.clone(this.attributes);return _.each(this.relations,function(b,c){a[c]=_.has(a,c)?a[c].toJSON():(new b).toJSON()}),a},a.Model.prototype.clone=function(){return new this.constructor(this.toJSON())},a.Collection.prototype.resetRelations=function(b){_.each(this.models,function(c){_.each(c.relations,function(d,e){c.get(e)instanceof a.Collection&&c.get(e).trigger("reset",c,b)})})},a.Collection.prototype.reset=function(a,b){b||(b={});for(var c=0,d=this.models.length;d>c;c++)this._removeReference(this.models[c]);return b.previousModels=this.models,this._reset(),this.add(a,_.extend({silent:!0},b)),b.silent||(this.trigger("reset",this,b),this.resetRelations(b)),this}});